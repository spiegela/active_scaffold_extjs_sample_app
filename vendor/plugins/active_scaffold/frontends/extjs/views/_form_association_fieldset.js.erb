<%
parent_record = @record
associated = column.singular_association? ? [parent_record.send(column.name)].compact : parent_record.send(column.name)
associated = associated.sort_by {|r| r.new_record? ? 99999999999 : r.id} unless column.association.options.has_key?(:order)

show_blank_record = (column.plural_association? or (column.singular_association? and associated.empty?))
show_blank_record = false if column.through_association?
show_blank_record = false unless column.association.klass.authorized_for?(:action => :create)
-%>
{ xtype: 'fieldset',
  title: '<%= column.label %>',
  collapsed: '<%= column.collapsed %>',
  collapsible: 'true'
  items: [
    
  ]
},

<% associated.each_index do |index| -%>
  <% @record = associated[index] -%>
  <% scope = column.plural_association? ? "[#{column.name}][#{@record.id || generate_temporary_id}]" : "[#{column.name}]"
  <%= render :partial => 'form_association_record', :locals => {:scope => scope, :parent_record => parent_record} %>
<% end -%>

<% if show_blank_record -%>
  <% @record = column.association.klass.new -%>
  <% scope = column.plural_association? ? "[#{column.name}][#{generate_temporary_id}]" : "[#{column.name}]" -%>
  <%= render :partial => 'form_association_record', :locals => {:scope => scope, :parent_record => parent_record} %>
<% end -%>
